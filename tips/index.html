<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><link rel="canonical" href="http://ruicunham.github.io/netronome-p4-documentation/tips/" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Tips and Tricks - Netronome P4 Documentation</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Tips and Tricks";
        var mkdocs_page_input_path = "tips.md";
        var mkdocs_page_url = "/netronome-p4-documentation/tips/";
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> Netronome P4 Documentation
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../getting-started/">Getting Started</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../vfs/">Virtual Interfaces</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../bmv2/">Migrating from bmv2</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../mac-cmd/">Mac Egress CMD</a>
                </li>
              </ul>
              <ul class="current">
                <li class="toctree-l1 current"><a class="reference internal current" href="./">Tips and Tricks</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#no-action-usage">No action usage</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#casting-variable-to-a-lower-number-of-bits">Casting variable to a lower number of bits</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#maximum-register-size">Maximum register size</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#validating-headers">Validating headers</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#using-variablesmetadata-as-keys-in-tables">Using variables/metadata as keys in tables.</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#cloning-and-multicasting-simultaneously">Cloning and Multicasting simultaneously</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#debugging-locks">Debugging Locks</a>
    </li>
    </ul>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../replication/">Replication</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../assets/">Useful Assets</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Netronome P4 Documentation</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
      <li class="breadcrumb-item active">Tips and Tricks</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="tips-and-tricks">Tips and Tricks</h1>
<p>This page presents some useful tips and tricks. It also compiles some <code>scripts</code> to help debugging P4 programs.</p>
<h2 id="no-action-usage">No action usage</h2>
<hr />
<p>Do not use <code>NoAction</code> outside of tables. In Netronome SmartNICs this will cause an error while loading: <code>design_data.c:262 table ingress::tbl_NoAction has no allowed actions</code>.</p>
<hr />
<h2 id="casting-variable-to-a-lower-number-of-bits">Casting variable to a lower number of bits</h2>
<hr />
<p>When casting a variable to a lower number of bits ensure that it won't cause an overflow. This will result in Undefined Behaviour, leading to the machine crashing and possibly the SmartNIC to overheat.</p>
<hr />
<h2 id="maximum-register-size">Maximum register size</h2>
<hr />
<p>The maximum number of values in a register is <code>2,147,483,647</code> a.k.a. maximum signed integer value.</p>
<hr />
<h2 id="validating-headers">Validating headers</h2>
<p>Even though Netronome's Documentation specifies that the validity of a header can be checked in a table using the match type <code>header_valid</code>, this does not appear to work properly. The solution is to use <code>if</code> conditions instead. </p>
<hr />
<h2 id="using-variablesmetadata-as-keys-in-tables">Using variables/metadata as keys in tables.</h2>
<p>When converted to <code>micro_c</code>, P4 variables and metadata are stored inside the scalars structure. When referencing these properties in the <code>p4cfg</code> file, they must be addressed in the following manner: </p>
<ul>
<li><code>scalars.&lt;VariableName&gt;</code></li>
<li><code>scalars.metadata@&lt;MetadataField&gt;</code></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Sometimes the compiler inserts <code>Ingress::</code> or <code>Egress::</code> before the <code>scalars.&lt;VariableName&gt;</code> depending if it is used in the Ingress or in the Egress.
To check if this prefix is needed you can check the <code>pifs/pif_debug.json</code> and search for <code>Ingress::scalars</code>, if it is defined, then it is the correct one to use.</p>
</div>
<hr />
<h2 id="cloning-and-multicasting-simultaneously">Cloning and Multicasting simultaneously</h2>
<p>In case you need to multicast a packet and also send it to another interface not on the multicast group, you can not do both simultaneously.
As a workaround, first, you need to clone the packet to the Ingress and forward the original one to the inerface outside the multicast group.
Then, in the Ingress, check for cloned packets, if true, multicast it.</p>
<hr />
<h2 id="debugging-locks">Debugging Locks</h2>
<p>This <code>script</code> is meant to be used before compiling a program. It will create a new set of registers that reflect the existent locks in the original program. Those registers can later be inspected to help identify acquisitions and releases of locks.</p>
<pre class="highlight"><code class="language-python">import json
import sys
import os
import re

if len(sys.argv) !=6:
    print("usage locksRegisterCompiler &lt;.c input file&gt; &lt;.p4cfg input file&gt; &lt;.c output file&gt; &lt;.p4cfg output file&gt; &lt;.p4 file&gt;")

with open(sys.argv[5]) as f: p4FileData = f.read()
with open(sys.argv[1]) as f: cFileData = f.read()
with open(sys.argv[2]) as f: p4cfgData = json.load(f)

for lock,numberOfLocks in re.findall(r"__declspec\(emem export aligned\(64\)\) int ([^\[;\s]+)(?:\[(.+)\])?\s*;",cFileData):
    if numberOfLocks=='':
        numberOfLocks=1
    else:
        if not numberOfLocks.isnumeric():
            r = re.findall(r"#define\s+"+numberOfLocks+r"\s+(\d+)",cFileData)[0]
            numberOfLocks=r
        numberOfLocks=int(numberOfLocks)
    p4cfgData["registers"]["configs"].append(
        {
            "count": numberOfLocks,
            "index": 0,
            "register": lock,
            "name": lock,
            "value": "0"
        }
    )
    release=lambda x:x.group(0)+(f"pif_register_{lock}[0].value=0;" if x.group(1)==None else f"pif_register_{lock}[{x.group(1)}].value=0;")
    acquire=lambda x:x.group(0)+(f"pif_register_{lock}[0].value=1;" if x.group(1)==None else f"pif_register_{lock}[{x.group(1)}].value=1;")

    if not re.search(r"release\(\s*\&amp;"+lock+r"(?:\[(.+)\])?\s*\)\s*;"+f"pif_register_{lock}"):
        cFileData = re.sub(
            r"release\(\s*\&amp;"+lock+r"(?:\[(.+)\])?\s*\)\s*;",
            release,
            cFileData)
    if not re.search(r"acquire\(\s*\&amp;"+lock+r"(?:\[(.+)\])?\s*\)\s*;"+f"pif_register_{lock}"):
        cFileData = re.sub(
            r"acquire\(\s*\&amp;"+lock+r"(?:\[(.+)\])?\s*\)\s*;",
            acquire,
            cFileData)
    if not re.search(f"register&lt;bit&lt;1&gt;&gt;({numberOfLocks}) {lock};"):
        p4FileData,_ = re.subn(
            "#include &lt;v1model.p4&gt;",
            f"#include &lt;v1model.p4&gt;\nregister&lt;bit&lt;1&gt;&gt;({numberOfLocks}) {lock};",
            p4FileData,1
        )

with open(sys.argv[3],"w") as f: f.write(cFileData)
with open(sys.argv[4],"w") as f: json.dump(p4cfgData,f,indent=4)
with open(sys.argv[5],"w") as f: f.write(p4FileData)</code></pre>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../mac-cmd/" class="btn btn-neutral float-left" title="Mac Egress CMD"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../replication/" class="btn btn-neutral float-right" title="Replication">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../mac-cmd/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../replication/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
